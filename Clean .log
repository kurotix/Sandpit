@echo off
setlocal enabledelayedexpansion

set "start_folder=E:\"
set "logDir=E:\protected\scriptsCleans"
set "logFile=!logDir!\cleanup_log_%date:~10,4%-%date:~4,2%-%date:~7,2%.txt"

if not exist "!logDir!" mkdir "!logDir!"

pushd %start_folder%
for /d %%i in (jenkins-*) do (
    pushd "%%i"
    
    for /r %%j in (*) do (
        if /i "%%~xj"==".log" (
            set "filename=%%~ni"
            set "filetime=%%~tj"
            set "currentTime=!time: =0!"
            set "filetime=!filetime: =0!"

            set /a "elapsedMinutes=(((1!currentTime:~0,2!-1!filetime:~0,2!)*60)+1!currentTime:~3,2!-1!filetime:~3,2!)"

            if /i not "!filename!"=="jenkins-slave.err" (
                if /i not "!filename!"=="jenkins-slave.out" (
                    if /i not "!filename!"=="Jenkins-slave.wrapper" (
                        if !elapsedMinutes! gtr 10 (
                            del "%%j" /q >> "!logFile!" 2^>^&1
                        )
                    )
                )
            )
        )
        
        if /i "%%~xj"==".mdmp" (
            set "filename=%%~ni"
            set "filetime=%%~tj"
            set "currentTime=!time: =0!"
            set "filetime=!filetime: =0!"

            set /a "elapsedMinutes=(((1!currentTime:~0,2!-1!filetime:~0,2!)*60)+1!currentTime:~3,2!-1!filetime:~3,2!)"

            if !elapsedMinutes! gtr 10 (
                del "%%j" /q >> "!logFile!" 2^>^&1
            )
        )
    )

    popd
)
popd

echo Suppression des fichiers .log et .mdmp terminée. Les détails sont enregistrés dans "!logFile!".
