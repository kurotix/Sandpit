@echo off
setlocal enabledelayedexpansion

set "logDir=E:\protected\scriptsCleans"
set "logFile=!logDir!\cleanup_log_%date:~10,4%-%date:~4,2%-%date:~7,2%.txt"

if not exist "!logDir!" mkdir "!logDir!"

cd /d E:\
for /d %%i in (jenkins-*) do (
    for /f "delims=" %%f in ('forfiles /p "%%i" /m *.log /c "cmd /c echo @file @ftime"') do (
        set "filename=%%~nf"
        set "filetime=%%~xf"
        set "currentTime=!time: =0!"
        set "filetime=!filetime: =0!"

        set /a "elapsedMinutes=(((1!currentTime:~0,2!-1!filetime:~0,2!)*60)+1!currentTime:~3,2!-1!filetime:~3,2!)"

        if /i not "!filename!"=="jenkins-slave.err.log" (
            if /i not "!filename!"=="jenkins-slave.out.log" (
                if /i not "!filename!"=="Jenkins-slave.wrapper.log" (
                    if !elapsedMinutes! gtr 10 (
                        del "%%i\!filename!.log" /q >> "!logFile!" 2>&1
                    )
                )
            )
        )
    )
)

echo Suppression des fichiers .log et .mdmp terminée. Les détails sont enregistrés dans "!logFile!".
